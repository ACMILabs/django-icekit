celery:
  # autoredeploy: true
  command: 'setup-django.sh celery.sh'
  deployment_strategy: high_availability
  environment:
    - BASE_SETTINGS_MODULE=production
    - DOTENV=production
  image: 'interaction/icekit:master'
  links:
    - elasticsearch
    - postgres
    - redis
  restart: on-failure
  tags:
    - icekit
  volumes:
    - /opt/django-icekit/project_template/var
celerybeat:
  # autoredeploy: true
  command: 'setup-django.sh celerybeat.sh'
  deployment_strategy: high_availability
  environment:
    - BASE_SETTINGS_MODULE=production
    - DOTENV=production
  image: 'interaction/icekit:master'
  links:
    - redis
  restart: on-failure
  tags:
    - icekit
  volumes:
    - /opt/django-icekit/project_template/var
celeryflower:
  # autoredeploy: true
  command: 'setup-django.sh celeryflower.sh'
  deployment_strategy: high_availability
  environment:
    - BASE_SETTINGS_MODULE=production
    - DOTENV=production
    - VIRTUAL_HOST=https://flower.example.com
  expose:
    - '5555'
  image: 'interaction/icekit:master'
  links:
    - redis
  restart: on-failure
  tags:
    - icekit
  volumes:
    - /opt/django-icekit/project_template/var
django:
  # autoredeploy: true
  command: 'setup-django.sh supervisord.sh'
  deployment_strategy: every_node
  environment:
    - BASE_SETTINGS_MODULE=production
    - DOTENV=production
    - VIRTUAL_HOST=https://www.example.com
  expose:
    - '8000'
  image: 'interaction/icekit:master'
  links:
    - celery
    - celerybeat
    - celeryflower
    - elasticsearch
    - postgres
    - redis
  restart: on-failure
  tags:
    - icekit
  volumes:
    - /opt/django-icekit/project_template/var
elasticsearch:
  # autoredeploy: true
  image: 'interaction/elasticsearch-icu:1-alpine'
  restart: on-failure
  tags:
    - icekit
haproxy:
  # autoredeploy: true
  environment:
    - 'EXTRA_SETTINGS=http-request add-header X-Forwarded-Proto https if { ssl_fc }'
  image: 'interaction/haproxy:master'
  links:
    - celeryflower
    - django
  ports:
    - '443:443'
  restart: on-failure
  roles:
    - global
  tags:
    - icekit
  volumes_from:
    - letsencrypt
letsencrypt:
  environment:
    - DOMAINS=www.example.com,flower.example.com
    - EMAIL=admin@example.com
  image: 'interaction/letsencrypt:master'
  ports:
    - '80:80'
  tags:
    - icekit
postgres:
  # autoredeploy: true
  image: 'postgres:9.4-alpine'
  restart: on-failure
  tags:
    - icekit
redis:
  # autoredeploy: true
  command: 'redis-server --appendonly yes'
  image: 'redis:3-alpine'
  restart: on-failure
  tags:
    - icekit
